#!/bin/bash

ShowUsage() {
	echo "Usage: $0 <client designator> <DNS Domain | domain file> <in-scope network file - NMAP format> <in-scope network file start/end format>"
	echo "$0 will attempt to automatically perform DNS queries, and sort through discovered hosts to come up with a basic reconnaissance report, then feed that over to nmap.TraceAndScan."
	echo ""
	echo "NOTE: directories, etc. will be created in the current directory."
	echo ""
	echo "The in-scope network start/end file should be in the format (one per line) <starting IP> <ending IP> rather than the nmap <subnet>/prefix or other formats in the nmap-style in-scope file."
	echo "     ex: 192.168.1.10 192.168.1.200"
	echo ""
}

if [ $# -lt 4 ]; then
	ShowUsage
	exit 1
fi

CLIENTDESIGNATOR=$1
BASEDOMAIN=$2
NMAPFILE="$3"
STARTENDIPFILE="$4"

# -------------  Validity Checks ---------------------
if [ ! -e $NMAPFILE ]; then
	echo "ERROR: Unable to find $NMAPFILE"
	exit 1
fi

if [ ! -e $STARTENDIPFILE ]; then
	echo "ERROR: Unable to find $STARTENDIPFILE"
	exit 2
fi

# create working directories if they don't exist
create_dirs.sh 2>&1 1>/dev/null

# Run Reconnaissance
cd recon
nmap.dns_reconnaissance.sh $BASEDOMAIN $NMAPFILE $STARTENDIPFILE `pwd`

# Run TraceAndScan
cd enum
nmap.TraceAndScanFromFile.sh --basedescriptor=$CLIENTDESIGNATOR --networkfile=$NMAPFILE --dnsfile=recon/all_hosts_in-range.txt --sslonly --nonmapfixed 

